<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Urban Civic - Home</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="header-placeholder"></div>

  <main id="app">
    <section id="view-home" class="view active">
      <div class="hero">
        <h1>Welcome to Urban Civic</h1>
        <p>Report and resolve civic issues in your community.</p>
        <a class="btn" href="report.html" style="background: #fff; color: var(--accent);">Report an Issue Now</a>
      </div>
      <div class="grid">
        <div>
          <div class="card">
            <h2>Recent Reports</h2>
            <div id="recent-list" class="list" aria-live="polite" role="region" aria-label="Recent civic issues"></div>
          </div>
          <div style="height:20px"></div>
          <div class="card">
            <h3>How it Works</h3>
            <ol class="muted small">
              <li>Report an issue with a photo and location.</li>
              <li>Community members upvote critical issues.</li>
              <li>Admins verify and update issue status.</li>
            </ol>
          </div>
        </div>
        <aside>
          <div class="card">
            <h3>Quick Actions</h3>
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:16px">
              <a class="btn" href="report.html">Report an Issue</a>
              <a class="btn" href="map.html">View Map</a>
              <a class="btn" href="issue.html">Browse Issues</a>
            </div>
          </div>
          <div style="height:16px"></div>
          <div class="card">
            <h3>Stats</h3>
            <div class="muted small" id="stats"></div>
          </div>
        </aside>
      </div>
    </section>

    <div id="issue-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content">
        <button class="modal-close" id="modal-close" aria-label="Close modal">‚úï</button>
        <h3 id="modal-title"></h3>
        <div id="modal-content"></div>
        <div class="comment-form">
          <label for="comment-input">Add a Comment</label>
          <textarea id="comment-input" aria-label="Add a comment"></textarea>
          <button class="btn" id="comment-submit" aria-label="Post comment">Post Comment</button>
        </div>
        <div class="comments" id="modal-comments"></div>
      </div>
    </div>
  </main>

  <footer>Built for your college project ‚Ä¢ Local storage backs demo data</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="js/common.js"></script>
  <script>
    // Load header
    fetch('includes/header.html')
      .then(response => response.text())
      .then(data => {
        qs('#header-placeholder').innerHTML = data;
        initHeader();
      });

    let statsChart = null;

    function initHeader() {
      qs('#nav-home').classList.add('active');
      qs('#menu-toggle').addEventListener('click', () => {
        qs('nav').classList.toggle('active');
      });
      document.addEventListener('click', e => {
        if (!qs('nav').contains(e.target) && !qs('#menu-toggle').contains(e.target)) {
          qs('nav').classList.remove('active');
        }
      });
      qsa('nav a').forEach(link => {
        link.addEventListener('click', () => {
          qs('nav').classList.remove('active');
        });
      });
      qs('#role').value = role;
      qs('#role').addEventListener('change', e => {
        role = e.target.value;
        localStorage.setItem('uc_role', role);
        updateProfileLink();
      });
      qs('#theme-toggle').addEventListener('click', () => {
        document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('uc_theme', document.body.dataset.theme);
        qs('#theme-toggle').textContent = document.body.dataset.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      });
      if (localStorage.getItem('uc_theme') === 'dark') {
        document.body.dataset.theme = 'dark';
        qs('#theme-toggle').textContent = '‚òÄÔ∏è';
      }
      updateProfileLink();
    }

    function updateProfileLink() {
      qs('#nav-profile').textContent = role === 'admin' ? 'Admin' : 'Profile';
    }

    function showModal(issue) {
      qs('#modal-title').textContent = issue.title;
      qs('#modal-content').innerHTML = `
        <img src="${issue.photo || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"300\"><rect width=\"100%\" height=\"100%\" fill=\"%23f3f9f8\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23004d40\">No Image</text></svg>'}" alt="${issue.title}">
        <div><strong>Category:</strong> ${issue.category}</div>
        <div><strong>Location:</strong> ${issue.location}</div>
        <div><strong>Description:</strong> ${issue.desc}</div>
        <div><strong>Status:</strong> <span class="status ${issue.status}">${issue.status}</span></div>
        <div><strong>Votes:</strong> ${issue.votes}‚ñ≤</div>
        <div><strong>Reported by:</strong> ${issue.reporter}</div>
        ${issue.assignedAt ? `<div><strong>Assigned:</strong> ${new Date(issue.assignedAt).toLocaleString()}</div>` : ''}
      `;
      qs('#modal-comments').innerHTML = issue.comments.map(c => `<div class="comment"><strong>${c.user}:</strong> ${c.text} <span class="muted small">(${new Date(c.timestamp).toLocaleString()})</span></div>`).join('');
      qs('#issue-modal').style.display = 'flex';
      qs('#issue-modal').classList.add('active');
      qs('#comment-input').focus();
      qs('#comment-submit').dataset.issueId = issue.id;
    }

    qs('#modal-close').addEventListener('click', () => {
      qs('#issue-modal').style.display = 'none';
      qs('#issue-modal').classList.remove('active');
      qs('#comment-input').value = '';
      delete qs('#comment-submit').dataset.issueId;
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && qs('#issue-modal').style.display === 'flex') {
        qs('#issue-modal').style.display = 'none';
        qs('#issue-modal').classList.remove('active');
        qs('#comment-input').value = '';
        delete qs('#comment-submit').dataset.issueId;
      }
    });

    qs('#comment-submit').addEventListener('click', () => {
      const comment = qs('#comment-input').value.trim();
      const issueId = Number(qs('#comment-submit').dataset.issueId);
      if (comment && issueId) {
        const issue = issues.find(i => i.id === issueId);
        if (issue) {
          issue.comments.push({ user: currentUser, text: comment, timestamp: new Date().toISOString() });
          saveData(issues);
          showToast('Comment added!');
          showModal(issue);
        }
      }
    });

    function renderRecent() {
      const el = qs('#recent-list');
      el.innerHTML = '';
      const sorted = [...issues].sort((a, b) => b.id - a.id).slice(0, 5);
      sorted.forEach(it => {
        const d = document.createElement('div');
        d.className = 'issue';
        d.innerHTML = `
          <img loading="lazy" src="${it.photo || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"300\"><rect width=\"100%\" height=\"100%\" fill=\"%23e9f9f8\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23004d40\">No Image</text></svg>'}" alt="${it.title}">
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700"><span class="category-icon">${getCategoryIcon(it.category)}</span>${it.title}</div>
              <div class="muted small">${it.votes}‚ñ≤</div>
            </div>
            <div class="muted small">${it.category} ‚Ä¢ ${it.location}</div>
            <div class="muted small">${it.assignedAt ? `Assigned: ${new Date(it.assignedAt).toLocaleString()}` : ''}</div>
            <div style="margin-top:12px">
              <button class="btn" data-open="${it.id}" aria-label="View details for ${it.title}">View Details</button>
            </div>
          </div>`;
        el.appendChild(d);
      });
      observeIssues(el);
    }

    function renderStats() {
      const stats = qs('#stats');
      const categoryCounts = issues.reduce((acc, issue) => {
        acc[issue.category] = (acc[issue.category] || 0) + 1;
        return acc;
      }, {});
      const labels = Object.keys(categoryCounts);
      const data = Object.values(categoryCounts);
      stats.innerHTML = `
        Total Reports: ${issues.length} ‚Ä¢ Open: ${issues.filter(i => i.status === 'open').length} ‚Ä¢ Upvotes Total: ${issues.reduce((s, i) => s + i.votes, 0)}
        <div style="margin-top:20px;"><canvas id="stats-chart"></canvas></div>
      `;


    
      // canvas and chart ka code for pie chart 

      const canvas = qs('#stats-chart');
      if (canvas) {
  if (statsChart) statsChart.destroy();

  const isDark = document.body.dataset.theme === 'dark'; // ‚úÖ Detect theme

  statsChart = new Chart(canvas, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: [
          '#e74c3c', // red
          '#3498db', // blue
          '#2ecc71', // green
          '#f1c40f', // yellow
          '#9b59b6', // purple
          '#e67e22', // orange
          '#1abc9c', // teal
          '#34495e'  // dark gray
        ],
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: { size: 14 },
            color: 'white' // ‚úÖ Dynamic legend color
          }
        },
        title: {
          display: true,
          text: 'Issue Distribution',
          color: 'white'// ‚úÖ Dynamic title color
        }
      }
    }
  });
}

    }

        document.addEventListener('click', e => {
      const openBtn = e.target.closest('[data-open]');
      if (openBtn) {
        const id = Number(openBtn.getAttribute('data-open'));
        const issue = issues.find(i => i.id === id);
        if (issue) showModal(issue);
      }
    });

    renderRecent();
    renderStats();

    // üîÑ Auto-refresh chart and recent issues when data changes
    document.addEventListener('issuesUpdated', () => {
      issues = JSON.parse(localStorage.getItem('uc_issues') || '[]');
      renderRecent();
      renderStats();
    });
  </script>
</body>
</html>
